// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VerificationType {
  UNIVERSITY
  HIGH_SCHOOL
  QUALIFICATION
}

enum ProblemStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum Subject {
  KOREAN
  MATH
  ENGLISH
  KOREAN_HISTORY
  SOCIAL_STUDIES
  SCIENCE
  SECOND_LANGUAGE
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum CommentSortOrder {
  NEWEST
  OLDEST
  MOST_LIKED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?
  name          String
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // OAuth fields
  googleId      String?   @unique
  kakaoId       String?   @unique

  // Relations
  verifications Verification[]
  problems      Problem[]
  reviewedProblems Problem[] @relation("ReviewedProblems")
  comments      Comment[]
  commentLikes  CommentLike[]
  submissions   ProblemSubmission[] @relation("ProblemSubmissions")

  @@index([email])
}

model Verification {
  id            String            @id @default(uuid())
  userId        String
  type          VerificationType
  status        VerificationStatus @default(PENDING)
  emailDomain   String?           // 이메일 도메인 (예: @university.ac.kr)
  documentUrl   String?           // 증명서류 URL (자격증의 경우)
  verifiedAt    DateTime?
  rejectedAt    DateTime?
  rejectionReason String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Problem {
  id            String    @id @default(uuid())
  title         String
  description   String?
  subject       Subject
  difficulty    Difficulty?
  pdfUrl        String    // 클라우드 스토리지 URL
  status        ProblemStatus @default(PENDING)
  submittedById String
  reviewedById  String?   // 운영진 ID
  reviewedAt    DateTime?
  rejectionReason String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  submittedBy   User              @relation(fields: [submittedById], references: [id])
  reviewedBy    User?             @relation("ReviewedProblems", fields: [reviewedById], references: [id])
  comments      Comment[]
  submission    ProblemSubmission?

  @@index([status])
  @@index([subject])
  @@index([submittedById])
}

model ProblemSubmission {
  id            String    @id @default(uuid())
  problemId     String    @unique
  submittedById String
  status        ProblemStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  problem       Problem   @relation(fields: [problemId], references: [id], onDelete: Cascade)
  submittedBy   User      @relation("ProblemSubmissions", fields: [submittedById], references: [id])

  @@index([status])
  @@index([submittedById])
}

model Comment {
  id            String    @id @default(uuid())
  content       String
  problemId     String
  authorId      String
  parentId      String?   // 대댓글을 위한 부모 댓글 ID
  likeCount     Int       @default(0)
  dislikeCount  Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // 소프트 삭제

  problem       Problem   @relation(fields: [problemId], references: [id], onDelete: Cascade)
  author        User      @relation(fields: [authorId], references: [id])
  parent        Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies       Comment[] @relation("CommentReplies")
  likes         CommentLike[]
  editHistory   CommentEditHistory[]

  @@index([problemId])
  @@index([authorId])
  @@index([parentId])
}

model CommentEditHistory {
  id            String    @id @default(uuid())
  commentId     String
  content       String    // 수정 전 내용
  editedAt      DateTime  @default(now())

  comment       Comment   @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([commentId])
}

model CommentLike {
  id            String    @id @default(uuid())
  commentId     String
  userId        String
  isLike        Boolean   // true: 좋아요, false: 싫어요
  createdAt     DateTime  @default(now())

  comment       Comment   @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}


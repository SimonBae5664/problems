generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  // Prisma generate는 DATABASE_URL 없이도 작동하지만, 
  // 빌드 시점에 환경 변수가 없으면 경고가 발생할 수 있음
}

model User {
  id               String              @id @default(uuid())
  name             String
  email            String              @unique
  username         String              @unique
  passwordHash     String
  role             UserRole            @default(USER)
  createdAt        DateTime            @default(now())
  googleId         String?             @unique
  kakaoId          String?             @unique
  comments         Comment[]
  commentLikes     CommentLike[]
  reviewedProblems Problem[]           @relation("ReviewedProblems")
  problems         Problem[]
  submissions      ProblemSubmission[] @relation("ProblemSubmissions")
  verifications    Verification[]
  files            File[]
  processingJobs   ProcessingJob[]
  userActivities   UserActivity[]
  studentRecords   StudentRecord[]

  @@index([email])
  @@index([username])
}

model Verification {
  id              String             @id @default(uuid())
  userId          String
  type            VerificationType
  status          VerificationStatus @default(PENDING)
  emailDomain     String?
  documentUrl     String?
  verifiedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Problem {
  id                String             @id @default(uuid())
  title             String
  description       String?
  subject           Subject
  difficulty        Difficulty?
  pdfUrl            String
  status            ProblemStatus      @default(PENDING)
  submittedById     String
  reviewedById      String?
  reviewedAt        DateTime?
  rejectionReason   String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  fileId            String? // Reference to File
  unit              String? // 단원
  tags              Json? // JSONB for tags
  extractedTextPath String? // Path to extracted text in derivatives bucket
  thumbnailPath     String? // Path to thumbnail in derivatives bucket
  comments          Comment[]
  reviewedBy        User?              @relation("ReviewedProblems", fields: [reviewedById], references: [id])
  submittedBy       User               @relation(fields: [submittedById], references: [id])
  submission        ProblemSubmission?
  file              File?              @relation(fields: [fileId], references: [id])
  userActivities    UserActivity[]

  @@index([status])
  @@index([subject])
  @@index([submittedById])
  @@index([fileId])
}

model ProblemSubmission {
  id            String        @id @default(uuid())
  problemId     String        @unique
  submittedById String
  status        ProblemStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  problem       Problem       @relation(fields: [problemId], references: [id], onDelete: Cascade)
  submittedBy   User          @relation("ProblemSubmissions", fields: [submittedById], references: [id])

  @@index([status])
  @@index([submittedById])
}

model Comment {
  id           String               @id @default(uuid())
  content      String
  problemId    String
  authorId     String
  parentId     String?
  likeCount    Int                  @default(0)
  dislikeCount Int                  @default(0)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  deletedAt    DateTime?
  author       User                 @relation(fields: [authorId], references: [id])
  parent       Comment?             @relation("CommentReplies", fields: [parentId], references: [id])
  replies      Comment[]            @relation("CommentReplies")
  problem      Problem              @relation(fields: [problemId], references: [id], onDelete: Cascade)
  editHistory  CommentEditHistory[]
  likes        CommentLike[]

  @@index([problemId])
  @@index([authorId])
  @@index([parentId])
}

model CommentEditHistory {
  id        String   @id @default(uuid())
  commentId String
  content   String
  editedAt  DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([commentId])
}

model CommentLike {
  id        String   @id @default(uuid())
  commentId String
  userId    String
  isLike    Boolean
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

enum UserRole {
  USER
  ADMIN
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VerificationType {
  UNIVERSITY
  HIGH_SCHOOL
  QUALIFICATION
}

enum ProblemStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum Subject {
  KOREAN
  MATH
  ENGLISH
  KOREAN_HISTORY
  SOCIAL_STUDIES
  SCIENCE
  SECOND_LANGUAGE
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum CommentSortOrder {
  NEWEST
  OLDEST
  MOST_LIKED
}

enum FileVisibility {
  PRIVATE
  SHARED
  PUBLIC
}

enum JobType {
  EXTRACT
  OCR
  CLASSIFY
  EMBED
  SUMMARIZE
  STUDENT_RECORD_ANALYZE
}

enum JobStatus {
  QUEUED
  PROCESSING
  SUCCEEDED
  FAILED
}

enum OutputType {
  TEXT
  JSON
  THUMB
  EMBEDDING
}

enum UserActivityAction {
  VIEW
  BOOKMARK
  SOLVE
  LIKE
}

enum RetentionPolicy {
  DELETE_IMMEDIATELY
  DELETE_AFTER_24H
  KEEP
}

// File metadata table
model File {
  id               String          @id @default(uuid())
  ownerId          String
  storagePath      String // Path in Supabase Storage (uploads bucket)
  originalFilename String
  mimeType         String
  fileExt          String
  size             Int // Size in bytes
  visibility       FileVisibility  @default(PRIVATE)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  owner            User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  problems         Problem[]
  processingJobs   ProcessingJob[]

  @@index([ownerId])
  @@index([visibility])
  @@index([createdAt])
}

// Processing jobs queue table
model ProcessingJob {
  id         String      @id @default(uuid())
  fileId     String
  ownerId    String
  jobType    JobType
  status     JobStatus   @default(QUEUED)
  attempts   Int         @default(0)
  error      String?
  lockedAt   DateTime? // For DB locking mechanism
  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  file       File        @relation(fields: [fileId], references: [id], onDelete: Cascade)
  owner      User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  outputs    JobOutput[]

  @@index([status])
  @@index([fileId])
  @@index([ownerId])
  @@index([createdAt])
  @@index([status, createdAt]) // For efficient polling
}

// Job outputs/results table
model JobOutput {
  id          String        @id @default(uuid())
  jobId       String
  outputType  OutputType
  storagePath String // Path in Supabase Storage (derivatives bucket)
  meta        Json? // Additional metadata (JSONB)
  createdAt   DateTime      @default(now())
  job         ProcessingJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([outputType])
}

// User activity tracking
model UserActivity {
  id        String             @id @default(uuid())
  userId    String
  problemId String?
  action    UserActivityAction
  meta      Json? // Additional metadata
  createdAt DateTime           @default(now())
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  problem   Problem?           @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([problemId])
  @@index([action])
  @@index([createdAt])
}

// Student records (생기부 분석 결과)
model StudentRecord {
  id              String          @id @default(uuid())
  ownerId         String
  fileId          String? // Reference to uploaded file
  status          JobStatus       @default(QUEUED)
  resultPath      String? // Path to analysis result in derivatives bucket
  retentionPolicy RetentionPolicy @default(DELETE_AFTER_24H)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  owner           User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([status])
  @@index([createdAt])
}
